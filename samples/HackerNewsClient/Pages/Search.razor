@page "/search"
@inject HackerNewsApi Api

<PageTitle>Hacker News Demo</PageTitle>

<MudText Typo="Typo.h3" GutterBottom>Search</MudText>

<div style="display: flex; gap: 16px">
    <MudTextField @bind-Value=_searchText
                  Label="Search"
                  Clearable
                  Variant="Variant.Outlined"
                  DebounceInterval="500"
                  Adornment="Adornment.End"
                  AdornmentIcon="@Icons.Filled.Search"
                  AdornmentColor="Color.Secondary" />
    <MudSelect T="DateTimeOffset?" @bind-Value="_startDate" Variant="Variant.Outlined" Label="Time range" Placeholder="All">
        <MudSelectItem T="DateTimeOffset?" Value="null"><div>All</div></MudSelectItem>
        <MudSelectItem T="DateTimeOffset?" Value="now.AddHours(-24)"><div>Last 24h</div></MudSelectItem>
        <MudSelectItem T="DateTimeOffset?" Value="now.AddDays(-7)"><div>Last 7 days</div></MudSelectItem>
    </MudSelect>
</div>

<UseEndpointInfinite
    Endpoint="Api.GetTopStories"
    Arg="@new(Page: 0, PageSize: 30, Query: _searchText, Tag: "story", StartDate: _startDate)"
    GetNextPageArg="(q, pageCount) => pageCount < q.Data?.NbPages ? q.Arg?.GetNextPageArgs() : null">
    <MudList>
        @foreach(var query in context.Pages)
        {
            @if (query.HasData)
            {
                var posts = query.Data;
                foreach (var post in posts.Hits)
                {
                    <MudListItem Style="padding-inline: 0">
                        <PostPreview @key="post.Id" Post="post" />
                    </MudListItem>
                }
            }
            else if (query.IsLoading)
            {
                <MudProgressLinear Indeterminate Style="margin-bottom: 200px" />
            }
            else
            {
                <MudAlert Severity="Severity.Error">
                    Something went wrong!
                    @query.Error?.Message
                    <MudButton OnClick="query.Refetch">Retry</MudButton>
                </MudAlert>
            }
        }
    </MudList>
    @if (context.HasNextPage)
    {
        <div style="display: flex; justify-content: center">
            <MudButton OnClick="context.LoadNextPage">Load More</MudButton>
        </div>
    }
</UseEndpointInfinite>

@code {
    string _searchText = "";
    DateTimeOffset? _startDate = null;

    readonly DateTimeOffset now = DateTimeOffset.Now;
}